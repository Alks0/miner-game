<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Miner Game - H5 Demo</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { background:#0b1020; color:#fff; font-family: system-ui, sans-serif; }
    .card { max-width: 420px; margin: 16px auto; padding: 16px; border-radius: 16px;
            background: linear-gradient(135deg, rgba(123,44,245,.25), rgba(44,137,245,.25));
            box-shadow:0 8px 20px rgba(0,0,0,.35), 0 0 12px rgba(123,44,245,.7); backdrop-filter: blur(10px); }
    input, button { width: 100%; padding: 10px; border-radius: 12px; border: none; margin: 6px 0; }
    button { color:#fff; background:linear-gradient(135deg,#7B2CF5,#2C89F5); box-shadow:0 8px 20px rgba(0,0,0,.35),0 0 12px #7B2CF5; cursor:pointer; }
    .row { display:flex; justify-content: space-between; }
    .bar { height:10px; border-radius:999px; background:rgba(255,255,255,.12); overflow:hidden }
    .fill { height:100%; width:0%; background:linear-gradient(90deg,#7B2CF5,#2C89F5); box-shadow:0 0 10px #7B2CF5; transition: width .3s ease; }
  </style>
  <script>
    const API_BASE = '/api';
    const WS_ENDPOINT = 'http://localhost:3000/game';
    let token = null;

    async function api(path, options={}){
      const headers = Object.assign({'Content-Type':'application/json'}, options.headers||{});
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch(API_BASE + path, Object.assign({}, options, { headers }));
      const json = await res.json().catch(()=>({}));
      if (!res.ok || (json && json.code >= 400)) throw new Error((json && json.message) || 'Request error');
      return json.data;
    }

    async function loginOrRegister(u, p){
      try {
        const r = await api('/auth/login', { method:'POST', body: JSON.stringify({username:u, password:p}) });
        token = r.access_token;
      } catch {
        const r = await api('/auth/register', { method:'POST', body: JSON.stringify({username:u, password:p}) });
        token = r.access_token;
      }
      const prof = await api('/user/profile');
      document.getElementById('ore').textContent = String(prof.oreAmount);
      document.getElementById('coin').textContent = String(prof.bbCoins);
      bindRealtime();
    }

    function bindRealtime(){
      if (!window.io || !token) return;
      const socket = io(WS_ENDPOINT, { auth: { token } });
      socket.on('mine.update', msg => {
        const amt = msg.cartAmount, cap = msg.cartCapacity;
        const pct = Math.min(1, (cap? amt/cap : 0));
        document.getElementById('fill').style.width = Math.round(pct*100)+'%';
        document.getElementById('percent').textContent = Math.round(pct*100)+'%';
      });
      socket.on('mine.collapse', msg => {
        console.log('mine.collapse', msg);
      });
      socket.on('plunder.attacked', msg => {
        const box = document.getElementById('events');
        const line = document.createElement('div');
        line.textContent = '被掠夺：' + JSON.stringify(msg);
        box.prepend(line);
      });
    }

    async function startMining(){
      await api('/mine/start', { method:'POST' });
      const cart = await api('/mine/cart');
      const pct = Math.min(1, (cart.cartAmount||0) / (cart.cartCapacity||1));
      document.getElementById('fill').style.width = Math.round(pct*100)+'%';
      document.getElementById('percent').textContent = Math.round(pct*100)+'%';
    }
    async function collect(){
      const r = await api('/mine/collect', { method:'POST' });
      const p = await api('/user/profile');
      document.getElementById('ore').textContent = String(p.oreAmount);
      document.getElementById('coin').textContent = String(p.bbCoins);
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('go').onclick = ()=>{
        const u = document.getElementById('u').value || 'user';
        const p = document.getElementById('p').value || 'password';
        loginOrRegister(u, p);
      };
      document.getElementById('start').onclick = ()=> startMining();
      document.getElementById('collect').onclick = ()=> collect();
    });
  </script>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 8px">登录 / 注册</h2>
    <input id="u" placeholder="用户名" />
    <input id="p" placeholder="密码" type="password" />
    <button id="go">进入</button>
  </div>
  <div class="card">
    <div class="row"><span>💎 矿石</span><strong id="ore">0</strong></div>
    <div class="row"><span>🪙 BB币</span><strong id="coin">0</strong></div>
  </div>
  <div class="card">
    <div style="opacity:.9;margin-bottom:8px;">⛏️ 挖矿</div>
    <div class="bar"><div id="fill" class="fill"></div></div>
    <div class="row" style="align-items:center;margin:8px 0 12px"><span>矿车</span><strong id="percent">0%</strong></div>
    <div class="row" style="gap:8px">
      <button id="start">开始挖矿</button>
      <button id="collect">收矿</button>
    </div>
  </div>
  <div class="card">
    <div>事件</div>
    <div id="events" style="font-family:monospace; font-size:12px; opacity:.9"></div>
  </div>
</body>
</html>